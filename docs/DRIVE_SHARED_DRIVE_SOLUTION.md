# サービスアカウントのストレージ容量不足エラーの解決方法（共有ドライブ使用）

## 問題の原因

[Google Developerフォーラム](https://discuss.google.dev/t/error-403-storagequotaexceeded-when-the-service-accounts-drive-is-completely-empty/194265)によると、**サービスアカウントにはストレージクォータがなく、ファイルを所有できません**。

そのため、サービスアカウントが通常のフォルダ（マイドライブ）にファイルを作成しようとすると、ストレージクォータ超過のエラーが発生します。

## 解決策: 共有ドライブ（Shared Drive）を使用する

サービスアカウントがファイルを作成する際、**共有ドライブ（Shared Drive）を使用する**ことで、サービスアカウントがファイルを所有する必要がなくなり、ストレージクォータの問題を回避できます。

## 実装の変更

Cloud Functionsのコードを修正して、共有ドライブをサポートするようにしました。

### 変更内容

1. **親フォルダが共有ドライブかどうかを確認**
2. **共有ドライブをサポートするパラメータを追加**
   - `supportsAllDrives: true`
   - `includeItemsFromAllDrives: true`
   - `corpora: "drive"`（共有ドライブの場合）

3. **ファイル作成時に共有ドライブをサポート**
   - `supportsAllDrives: true`を追加

## 確認手順

### ステップ1: 親フォルダが共有ドライブかどうかを確認

1. **Google Driveで親フォルダを開く**
   - オーナーアカウントで [Google Drive](https://drive.google.com/) にログイン
   - 親フォルダID（`DRIVE_PARENT_ID`）を使用してフォルダを開く
   - URL形式: `https://drive.google.com/drive/folders/{DRIVE_PARENT_ID}`

2. **フォルダの種類を確認**
   - 共有ドライブの場合、フォルダのパスに「共有ドライブ」と表示されます
   - または、フォルダを右クリック → 「共有ドライブの詳細」を選択して確認

### ステップ2: 親フォルダが共有ドライブでない場合

親フォルダが通常のフォルダ（マイドライブ）の場合、以下のいずれかの方法で解決できます：

#### 方法A: 共有ドライブを作成して使用する（推奨）

1. **共有ドライブを作成**
   - Google Driveで「新規」→「共有ドライブ」を選択
   - 共有ドライブ名を入力して作成

2. **サービスアカウントを共有ドライブのメンバーに追加**
   - 共有ドライブを右クリック → 「共有ドライブのメンバーを管理」
   - サービスアカウントのメールアドレスを追加
   - 権限を「コンテンツ マネージャー」または「編集者」に設定

3. **Secret Managerの`DRIVE_PARENT_ID`を更新**
   - 共有ドライブのIDを`DRIVE_PARENT_ID`に設定
   - または、共有ドライブ内に親フォルダを作成して、そのフォルダIDを設定

#### 方法B: 親フォルダを共有ドライブに移動する

1. **共有ドライブを作成**
2. **親フォルダを共有ドライブに移動**
3. **サービスアカウントを共有ドライブのメンバーに追加**

### ステップ3: Cloud Functionsを再デプロイ

コードを修正した後、Cloud Functionsを再デプロイしてください：

```bash
npm run functions:deploy:drive
```

## 共有ドライブの権限設定

サービスアカウントを共有ドライブのメンバーに追加する際、以下の権限が必要です：

- **コンテンツ マネージャー**: ファイルとフォルダの作成・編集・削除が可能 ✅ **推奨**
- **編集者**: ファイルとフォルダの作成・編集が可能 ✅ **これでも可**
- **閲覧者**: ファイルの閲覧のみ可能 ❌ **不十分**

## トラブルシューティング

### エラーが続く場合

1. **親フォルダが共有ドライブかどうかを確認**
   - 共有ドライブでない場合、共有ドライブを作成して使用してください

2. **サービスアカウントが共有ドライブのメンバーかどうかを確認**
   - 共有ドライブのメンバー一覧にサービスアカウントのメールアドレスが含まれているか確認
   - 権限が「コンテンツ マネージャー」または「編集者」になっているか確認

3. **Cloud Functionsを再デプロイ**
   - コードを修正した後、必ず再デプロイしてください

## 参考リンク

- [Google Developerフォーラム - サービスアカウントのストレージ容量不足エラー](https://discuss.google.dev/t/error-403-storagequotaexceeded-when-the-service-accounts-drive-is-completely-empty/194265)
- [Google Drive API - 共有ドライブのサポート](https://developers.google.com/drive/api/guides/enable-shareddrives)
- [Google Workspace - 共有ドライブの管理](https://support.google.com/a/answer/7212025)
