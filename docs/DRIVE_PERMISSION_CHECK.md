# Google Drive権限の確認と設定方法

## 問題の症状

- オーナーのドライブ容量は1TB空いている
- しかし、Cloud Functionsから容量不足エラーが出る
- フォルダは作成できるが、チェックシート（ファイル）は作成できない

## 原因の可能性

### 1. サービスアカウントが親フォルダにアクセス権限を持っていない

サービスアカウントが親フォルダ（`DRIVE_PARENT_ID`）にアクセス権限を持っていない場合、ファイルを作成できません。

### 2. サービスアカウントが使用しているアカウントが異なる

サービスアカウントが使用しているGoogleアカウントと、オーナーアカウントが異なる可能性があります。

## 確認手順

### ステップ1: サービスアカウントのメールアドレスを確認

**GCP Console（Web UI）で確認**

1. [GCP Console](https://console.cloud.google.com/) → 「Secret Manager」→ `DRIVE_SERVICE_ACCOUNT_KEY` → 最新バージョン → 「シークレット値を表示」
2. JSONの中の`client_email`フィールドを確認
3. 詳細な手順は `docs/CHECK_SERVICE_ACCOUNT_EMAIL.md` を参照

### ステップ2: 親フォルダIDを確認

**GCP Console（Web UI）で確認**

1. [GCP Console](https://console.cloud.google.com/) → 「Secret Manager」→ `DRIVE_PARENT_ID` → 最新バージョン → 「シークレット値を表示」
2. フォルダIDを確認（例: `14l_ggl_SBo8FxZFDOKnmN7atbmaG-Rdh`）

### ステップ3: 親フォルダの権限を確認

1. **Google Driveで親フォルダを開く**
   - オーナーアカウントで [Google Drive](https://drive.google.com/) にログイン
   - 親フォルダIDを使用してフォルダを開く
   - URL形式: `https://drive.google.com/drive/folders/{DRIVE_PARENT_ID}`

2. **フォルダの共有設定を確認**
   - フォルダを右クリック → 「共有」を選択
   - または、フォルダを開いて右上の「共有」ボタンをクリック

3. **サービスアカウントのメールアドレスが共有されているか確認**
   - 共有ユーザー一覧にサービスアカウントのメールアドレス（`client_email`）が表示されているか確認
   - 権限が「編集者」または「閲覧者（コメント可）」になっているか確認

### ステップ4: サービスアカウントに権限を付与する

サービスアカウントのメールアドレスが共有されていない場合、または権限が不足している場合：

1. **親フォルダの共有設定を開く**
   - フォルダを右クリック → 「共有」を選択

2. **サービスアカウントのメールアドレスを追加**
   - 「ユーザーやグループを追加」にサービスアカウントのメールアドレス（`client_email`）を入力
   - 権限を「**編集者**」に設定
   - 「通知を送信」のチェックを外す（サービスアカウントはメールを受け取れないため）
   - 「送信」をクリック

3. **権限が正しく設定されたか確認**
   - 共有ユーザー一覧にサービスアカウントのメールアドレスが表示されているか確認
   - 権限が「編集者」になっているか確認

## 権限の種類と必要な権限

### Google Driveの権限レベル

- **閲覧者**: ファイルを閲覧できるが、編集・作成はできない
- **閲覧者（コメント可）**: ファイルを閲覧・コメントできるが、編集・作成はできない
- **編集者**: ファイルを閲覧・編集・作成できる ✅ **これが必要**
- **所有者**: すべての権限を持つ

### 必要な権限

サービスアカウントには、親フォルダに対して**「編集者」**の権限が必要です。

- ✅ **フォルダ作成**: 編集者権限で可能
- ✅ **ファイル作成**: 編集者権限で可能
- ✅ **ファイル編集**: 編集者権限で可能

## トラブルシューティング

### サービスアカウントのメールアドレスが見つからない場合

1. **GCP Consoleでサービスアカウントを確認**
   - [GCP Console](https://console.cloud.google.com/) → 「IAMと管理」→「サービスアカウント」
   - Drive APIを使用しているサービスアカウントを確認
   - メールアドレスをコピー

2. **Secret Managerの`DRIVE_SERVICE_ACCOUNT_KEY`を確認**
   - `client_email`フィールドを確認

### 権限を付与してもエラーが出る場合

1. **権限の反映を待つ**
   - 権限の変更が反映されるまで数分かかる場合があります
   - 数分待ってから再度試してください

2. **親フォルダIDが正しいか確認**
   - Secret Managerの`DRIVE_PARENT_ID`が正しいフォルダIDか確認
   - フォルダのURLからIDを確認（`https://drive.google.com/drive/folders/{ID}`）

3. **サービスアカウントが正しいアカウントか確認**
   - Secret Managerの`DRIVE_SERVICE_ACCOUNT_KEY`の`client_email`が正しいか確認

4. **Cloud Functionsを再デプロイ**
   - 権限を変更した後、Cloud Functionsを再デプロイする必要はありませんが、念のため再試行してください

### 容量不足エラーが続く場合

1. **サービスアカウントが使用しているアカウントを確認**
   - サービスアカウントの`client_email`に関連付けられているGoogleアカウントを確認
   - そのアカウントでGoogle Driveにログインしてストレージ使用状況を確認

2. **オーナーアカウントとサービスアカウントが異なる場合**
   - サービスアカウントが使用しているアカウントのストレージ容量を確認
   - そのアカウントのストレージ容量が不足している可能性があります

## 確認チェックリスト

- [ ] サービスアカウントのメールアドレス（`client_email`）を確認
- [ ] 親フォルダID（`DRIVE_PARENT_ID`）を確認
- [ ] 親フォルダをGoogle Driveで開く
- [ ] 親フォルダの共有設定を確認
- [ ] サービスアカウントのメールアドレスが共有ユーザー一覧に含まれているか確認
- [ ] サービスアカウントの権限が「編集者」以上になっているか確認
- [ ] 権限を付与した後、数分待ってから再度試す

## 参考リンク

- [Google Drive のファイルとフォルダを共有する](https://support.google.com/drive/answer/7166529)
- [GCP Console - Secret Manager](https://console.cloud.google.com/security/secret-manager)
- [GCP Console - サービスアカウント](https://console.cloud.google.com/iam-admin/serviceaccounts)
