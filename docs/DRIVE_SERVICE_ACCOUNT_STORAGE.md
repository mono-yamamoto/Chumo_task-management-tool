# サービスアカウントが使用しているGoogleアカウントのストレージ容量を確認する方法

## 問題の状況

- サービスアカウントには親フォルダへの「編集者」権限がある
- オーナーアカウントのドライブ容量は1TB空いている
- しかし、Cloud Functionsから容量不足エラーが出る

## 原因

**サービスアカウントが使用しているGoogleアカウントと、オーナーアカウントが異なる可能性が高いです。**

サービスアカウントキー（`DRIVE_SERVICE_ACCOUNT_KEY`）に含まれる`client_email`に関連付けられているGoogleアカウントのストレージ容量が不足している可能性があります。

## 確認手順

### ステップ1: サービスアカウントのメールアドレスを確認

**GCP Console（Web UI）で確認**

1. [GCP Console](https://console.cloud.google.com/) → 「Secret Manager」→ `DRIVE_SERVICE_ACCOUNT_KEY` → 最新バージョン → 「シークレット値を表示」
2. JSONの中の`client_email`フィールドを確認
3. 詳細な手順は `docs/CHECK_SERVICE_ACCOUNT_EMAIL.md` を参照

例: `drive-service-account@chumo-3506a.iam.gserviceaccount.com`

### ステップ2: サービスアカウントが使用しているGoogleアカウントを特定

サービスアカウントのメールアドレス（`@xxxxx.iam.gserviceaccount.com`）は、GCPプロジェクトに関連付けられています。

**重要なポイント**:

- サービスアカウント自体にはストレージ容量はありません
- サービスアカウントキーを作成したGoogleアカウント（またはサービスアカウントに権限を付与したGoogleアカウント）のストレージ容量が問題です
- **通常、プロジェクトのオーナーまたは作成者のGoogleアカウントが関連付けられています**

### ステップ3: プロジェクトのオーナーを確認

1. [GCP Console](https://console.cloud.google.com/) → 「IAMと管理」→「IAM」
2. プロジェクトのオーナー（`Owner`ロール）を確認
3. そのオーナーアカウントのメールアドレスを確認

**注意**: オーナーアカウントと、サービスアカウントが使用しているアカウントが異なる場合があります。

### ステップ4: サービスアカウントキーを作成したアカウントを確認

サービスアカウントキーを作成したGoogleアカウントが、サービスアカウントが使用しているアカウントです。

**確認方法**:

1. GCP Console → 「IAMと管理」→「サービスアカウント」
2. Drive APIを使用しているサービスアカウントを確認
3. 「キー」タブで、キーを作成したユーザーを確認（可能な場合）

### ステップ5: そのGoogleアカウントのストレージ容量を確認

1. **そのGoogleアカウントでGoogle Driveにログイン**
   - サービスアカウントキーを作成したGoogleアカウントで [Google Drive](https://drive.google.com/) にアクセス
   - または、プロジェクトのオーナーアカウントでGoogle Driveにアクセス

2. **ストレージ使用状況を確認**
   - 左下の「**ストレージ**」をクリック
   - 使用量と上限を確認
   - **上限に達しているか確認**

3. **ストレージ容量が不足している場合**
   - 不要なファイルを削除
   - またはストレージプランをアップグレード

## よくある質問

### Q: オーナーアカウントのドライブ容量は1TB空いているのに、なぜ容量不足エラーが出るの？

A: **サービスアカウントが使用しているGoogleアカウントと、オーナーアカウントが異なる可能性が高いです。**

サービスアカウントキーを作成したGoogleアカウント（またはサービスアカウントに権限を付与したGoogleアカウント）のストレージ容量が不足している可能性があります。

### Q: サービスアカウントが使用しているアカウントをどうやって確認するの？

A: 以下の方法で確認できます：

1. **プロジェクトのオーナーを確認**
   - GCP Console → 「IAMと管理」→「IAM」
   - `Owner`ロールを持つアカウントを確認

2. **サービスアカウントキーを作成したアカウントを確認**
   - サービスアカウントキーを作成したGoogleアカウントが、サービスアカウントが使用しているアカウントです

3. **そのアカウントでGoogle Driveにログインしてストレージ容量を確認**

### Q: オーナーアカウントとサービスアカウントが使用しているアカウントが異なる場合、どうすればいい？

A: 以下のいずれかの方法で解決できます：

1. **サービスアカウントが使用しているアカウントのストレージ容量を確保**
   - そのアカウントでGoogle Driveにログイン
   - 不要なファイルを削除
   - またはストレージプランをアップグレード

2. **オーナーアカウントで新しいサービスアカウントキーを作成**
   - オーナーアカウントでGCP Consoleにアクセス
   - 新しいサービスアカウントキーを作成
   - Secret Managerの`DRIVE_SERVICE_ACCOUNT_KEY`を更新

## トラブルシューティング

### サービスアカウントが使用しているアカウントがわからない場合

1. **プロジェクトのオーナーを確認**
   - GCP Console → 「IAMと管理」→「IAM」
   - `Owner`ロールを持つアカウントを確認

2. **そのアカウントでGoogle Driveにログイン**
   - ストレージ使用状況を確認

3. **ストレージ容量が不足している場合**
   - 不要なファイルを削除
   - またはストレージプランをアップグレード

### 複数のオーナーがいる場合

複数のオーナーがいる場合、サービスアカウントキーを作成したオーナーのアカウントのストレージ容量を確認してください。

## 確認チェックリスト

- [ ] サービスアカウントのメールアドレス（`client_email`）を確認
- [ ] プロジェクトのオーナーを確認
- [ ] サービスアカウントキーを作成したアカウントを特定
- [ ] そのアカウントでGoogle Driveにログイン
- [ ] そのアカウントのストレージ使用状況を確認
- [ ] ストレージ容量が不足している場合は、不要なファイルを削除またはストレージプランをアップグレード

## 参考リンク

- [GCP Console - IAM](https://console.cloud.google.com/iam-admin/iam)
- [GCP Console - サービスアカウント](https://console.cloud.google.com/iam-admin/serviceaccounts)
- [Google Drive ストレージの管理](https://support.google.com/drive/answer/2375123)
